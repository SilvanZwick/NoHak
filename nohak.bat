@echo off


:checkForWinPE
    where wpeutil
    if %errorlevel% neq 0 exit /b 1 else exit /b 0

:displaySplash
    echo ********************************************************************************
    echo ********************************************************************************
    echo *********** ::::    :::  ::::::::  :::    :::     :::     :::    ::: ***********
    echo *********** :+:+:   :+: :+:    :+: :+:    :+:   :+: :+:   :+:   :+:  ***********
    echo *********** :+:+:+  +:+ +:+    +:+ +:+    +:+  +:+   +:+  +:+  +:+   ***********
    echo *********** +#+ +:+ +#+ +#+    +:+ +#++:++#++ +#++:++#++: +#++:++    ***********
    echo *********** +#+  +#+#+# +#+    +#+ +#+    +#+ +#+     +#+ +#+  +#+   ***********
    echo *********** #+#   #+#+# #+#    #+# #+#    #+# #+#     #+# #+#   #+#  ***********
    echo *********** ###    ####  ########  ###    ### ###     ### ###    ### ***********
    echo ********************************************************************************
    echo ********************************************************************************
    echo ********************** NoHak Script v1.0.0 for Windows PE **********************
    echo ******************************** by TheZwick32 *********************************
    echo ***************************** www.silvanzwick.com ******************************
    echo ********************************************************************************
exit /b 0

:displayErrorArt
    echo             ????????????????
    echo          ??????????????????????
    echo       ????????????????????????????
    echo     ????????????????????????????????
    echo    ??????????????????????????????????
    echo   ????????????????????????????????????
    echo  ??????????????????????????????????????
    echo ????????????????????????????????????????
    echo ????????????????????????????????????????
    echo ????????????????????????????????????????
    echo ????????????????????????????????????????
    echo ????????????????????????????????????????
    echo ????????????????????????????????????????
    echo  ??????????????????????????????????????
    echo   ????????????????????????????????????
    echo    ??????????????????????????????????
    echo     ????????????????????????????????
    echo       ????????????????????????????
    echo          ??????????????????????
    echo             ????????????????
exit /b 0

:removeMalware
    echo | set /p="Please wait. Uncompressing malware database . . . "
    timeout /t 7 /nobreak >nul
    echo Done.

    echo | set /p="Please wait. Scanning system . . . "
    timeout /t 10 /nobreak >nul
    echo Done.

    echo | set /p="Please wait. Removing threats . . . "
    del /q "C:\Windows\system32\Utilman.exe"
    move /y "C:\Windows\system32\Utilman2.exe" "C:\Windows\system32\Utilman.exe"
    timeout /t 11 /nobreak >nul
    echo Done.

    echo Threats removed.
    echo | set /p="Please wait. Cleaning up . . . "
    timeout /t 1 /nobreak >nul
    echo Done.
exit /b 0

:start
    call :displaySplash
    echo.

    rem Check if the user is on Windows PE and if not then error.
    call :checkForWinPE
    if errorlevel 1 (
        call :displayErrorArt
        echo.
        echo ERROR: This script is not running in Windows PE.
        echo        Please follow the instructions at
        echo        https://files.catbox.moe/8bzair.txt to
        echo        boot into Windows PE.
    )

    echo What would you like to do?
    echo   1. Scan and remove threats
    echo   2. Exit
    set /P ui=? 
    if not %ui%=="1" (
        exit /b 1
    ) else (
        call :removeMalware
        echo All done!
        echo Rebooting system . . . 
        wpeutil reboot
    )
exit /b 0

call :start
exit
